name: Build SyncTime

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/synctime-build

jobs:
  build-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

  build-synctime:
    runs-on: ubuntu-latest
    needs: build-image
    permissions:
      contents: read
      packages: read

    container:
      image: ghcr.io/${{ github.repository_owner }}/synctime-build:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find compiler and build SyncTime
        run: |
          # Find where the cross-compiler is installed
          COMPILER=$(which m68k-amigaos-gcc 2>/dev/null || find /opt /usr -name "m68k-amigaos-gcc" -type f 2>/dev/null | head -1)
          if [ -z "$COMPILER" ]; then
            echo "Error: m68k-amigaos-gcc not found"
            exit 1
          fi
          PREFIX=$(dirname $(dirname $COMPILER))
          echo "Using PREFIX=$PREFIX"
          echo "Compiler version:"
          $COMPILER --version
          make clean || true
          make PREFIX=$PREFIX
          echo "Build successful:"
          ls -la SyncTime
          file SyncTime

      - name: Create Aminet LHA archive
        run: |
          VERSION=$(cat version.txt | tr -d '\n')
          # Update version in readme
          sed -i "s/^Version:.*/Version:      $VERSION/" SyncTime.readme
          # Create archive directory structure (use different name to avoid conflict with binary)
          mkdir -p dist/SyncTime
          cp SyncTime dist/SyncTime/
          cp SyncTime.info dist/SyncTime/
          cp README.md dist/SyncTime/
          cp LICENSE dist/SyncTime/
          # Create LHA archive
          cd dist && lha c ../SyncTime.lha SyncTime/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SyncTime
          path: |
            SyncTime.lha
            SyncTime.readme
            SyncTime
            SyncTime.info
          retention-days: 30

  release:
    runs-on: ubuntu-latest
    needs: build-synctime
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: SyncTime

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            SyncTime.lha
            SyncTime.readme
          generate_release_notes: true
